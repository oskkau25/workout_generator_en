name: ğŸ¤– Automated Test Pipeline

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]
  workflow_dispatch:  # Allow manual triggering

jobs:
  automated-testing:
    runs-on: ubuntu-latest
    
    steps:
    - name: ğŸš€ Checkout code
      uses: actions/checkout@v4
      
    - name: ğŸ Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.9'
        
    - name: ğŸ“¦ Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install requests
        
    - name: ğŸ” Run Automated Test Pipeline
      run: |
        chmod +x run_automated_tests.sh
        ./run_automated_tests.sh
        
    - name: ğŸ“Š Upload Test Results
      uses: actions/upload-artifact@v3
      if: always()
      with:
        name: test-results
        path: |
          automated_test_results.json
          test_pipeline.log
          ai_code_review_report.json
          
    - name: ğŸ“‹ Display Test Summary
      if: always()
      run: |
        echo "=== ğŸ§ª TEST PIPELINE RESULTS ==="
        if [ -f "automated_test_results.json" ]; then
          echo "Overall Status: $(python -c "import json; data=json.load(open('automated_test_results.json')); print(data.get('overall_status', 'UNKNOWN'))")"
          echo "Release Ready: $(python -c "import json; data=json.load(open('automated_test_results.json')); print(data.get('release_ready', False))")"
          echo "Success Rate: $(python -c "import json; data=json.load(open('automated_test_results.json')); print(data.get('summary', {}).get('success_rate', '0%'))")"
        else
          echo "âŒ Test results file not found"
        fi
        
    - name: ğŸš¨ Fail on Critical Issues
      if: failure()
      run: |
        echo "âŒ Pipeline failed! Check the logs above for details."
        exit 1
        
    - name: âœ… Success Notification
      if: success()
      run: |
        echo "ğŸ‰ All tests passed! Code is ready for release."
        
  quality-gate:
    needs: automated-testing
    runs-on: ubuntu-latest
    if: always()
    
    steps:
    - name: ğŸš€ Checkout code
      uses: actions/checkout@v4
      
    - name: ğŸ“Š Download Test Results
      uses: actions/download-artifact@v3
      with:
        name: test-results
        
    - name: ğŸ” Quality Gate Check
      run: |
        if [ -f "automated_test_results.json" ]; then
          OVERALL_STATUS=$(python -c "import json; data=json.load(open('automated_test_results.json')); print(data.get('overall_status', 'UNKNOWN'))")
          RELEASE_READY=$(python -c "import json; data=json.load(open('automated_test_results.json')); print(data.get('release_ready', False))")
          
          echo "=== ğŸšª QUALITY GATE ==="
          echo "Overall Status: $OVERALL_STATUS"
          echo "Release Ready: $RELEASE_READY"
          
          if [ "$RELEASE_READY" = "True" ]; then
            echo "âœ… QUALITY GATE PASSED - Code can be released"
          else
            echo "âŒ QUALITY GATE FAILED - Code needs fixes before release"
            exit 1
          fi
        else
          echo "âŒ Test results not available"
          exit 1
        fi
